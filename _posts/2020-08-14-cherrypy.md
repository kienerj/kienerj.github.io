---
layout: post
title: Setting up CherryPy
subtitle: a minimalist python web framework
tags: [rdkit, python, cherrypy]
comments: true
---

[CherryPy](https://cherrypy.org/) is a minimalist python web framework. You may ask what "minimalist" means in the context of web frameworks? It does not offer any front-end tools and does not offer any ORM. But you can use one of your choice if you whish to do so. It's unopinionated. You can access your data directly with the according database-specific library (cx_Oracle, psycopg2,...) or combine it with SQLAlchemy. It's up to you. I really prefer it for creating simple web services that can be used over multiple applications. In this blog post I will outline how to setup CherryPy on an Ubuntu server.

## Installing CherryPy

CherryPy is available via pip or conda. Back when I started using it, the build on conda was outdated. Right now it's up to date but looking at the history I'm not sure the official maintainers regularly update the conda builds. Since this is a pure python module I suggest to stick with the official guide and install CherryPy via pip. We will use a conda environment so you will need to have anaconda or miniconda already installed.

```bash
conda create -c rdkit -n cherrypy python=3.7 rdkit
conda activate cherrypy
conda install pip
pip install cherrypy
```

We will use python 3.7 because RDKit as of now does not have an official 3.8 build available on conda and the end-goal will be to build webservices that make use of RDKit functionality. You may also install additional packages into this environment as per your needs.

You can test the installation by running the `Hellow World` tutorial:

```python
python -m cherrypy.tutorial.tut01_helloworld
```

And then open http://127.0.0.1:8080/ in your browser which should display "Hello world!".

## Running CherryPy applications

CherryPy ships with it's own integrated HTTP/1.1-compliant, WSGI thread-pooled Web Server which is production ready. In fact you can use it to serve any WSGI-based python web application even if not built with CherryPy framework. It can also [serve static files](https://docs.cherrypy.org/en/latest/basics.html#static-content-serving). Depending on your needs and setup, nothing else is required. 

### CherryPy standalone

To run CherryPy as standalone application without any other web server, you can simply look at the [tutorials](https://docs.cherrypy.org/en/latest/tutorials.html#id3) and expand on them. The `Hello world` example we used to test the installation looks as follow:

```python
import cherrypy


class HelloWorld(object):
    @cherrypy.expose
    def index(self):
        return "Hello world!"


if __name__ == '__main__':
    cherrypy.quickstart(HelloWorld())
```

The application needs a main method which launches cherrypy webserver and the application itself. By default it will bind to 127.0.0.1:8080. An application is a class and available actions are methods that are annotated with `@cherrypy.expose`. The `index`method has special meaning as it is accessible to the base url of the application. You can add a second method to the class that will generate a random string:

```python
import random
import string
import cherrypy


class StringGenerator(object):
    @cherrypy.expose
    def index(self):
        return "Hello world!"

    @cherrypy.expose
    def generate(self):
        return ''.join(random.sample(string.hexdigits, 8))


if __name__ == '__main__':
    cherrypy.quickstart(StringGenerator())

```

If you save this into a file and run it (`python tut02.py`), the `generate`method will be available at  http://localhost:8080/generate. 

### CherryPy behind Apache (on Ubuntu)

In this section I will outline one of multiple way to run CherryPy behind Apache acting as reverse proxy. This can be useful if needing to run the CherryPy apps on an existing webserver that already has Apache installed. I would expect the steps for other web servers like nginx to be similar.  

1. Install Apache

    ```bash
    sudo apt update
    sudo apt install apache2
    ```

2. Enable `mod_proxy

    ```bash
    sudo a2enmod proxy_http
    ```

3. Add Location to Apache configuration

    ```
    <Location /cherrypy-app>
    	Order allow,deny
    	allow from all
    	ProxyPass http://127.0.0.1:8080
    	ProxyPassReverse http://127.0.0.1:8080
    </Location>
    ```
    You need to adjust the location path accordingly. The port can also be changed but you must keep the chosen port in mind as it will be needed again later on.

4. 